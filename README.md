# AZD Template for ASP.NET Core with a secure App Service and SQL Database architecture

This is an infrastructure-only template that doesn't include any application code. You can use it to quickly create the resources you need to deploy a data-driven ASP.NET Core web app to Azure. For an example, see [Tutorial: Deploy an ASP.NET Core and Azure SQL Database app to Azure App Service](https://learn.microsoft.com/en-us/azure/app-service/tutorial-dotnetcore-sqldb-app). It provisions the following resources in an Azure resource group:

- A [virtual network](https://learn.microsoft.com/azure/virtual-network/virtual-networks-overview).
- A VNET-integrated [App Service](https://learn.microsoft.com/azure/app-service/overview) app.
- An [Azure SQL Database](https://learn.microsoft.com/azure/azure-sql/database/sql-database-paas-overview), accessible only from within the virtual network.
- An [Azure Cache for Redis](https://learn.microsoft.com/azure/azure-cache-for-redis/cache-overview), accessible only from within the virtual network.
- A [Log Analytics workspace](https://learn.microsoft.com/azure/azure-monitor/logs/log-analytics-workspace-overview) to ship App Service logs.

## Quick deployment

To deploy your data-driven ASP.NET Core web app, make sure you have [installed AZD](https://learn.microsoft.com/azure/developer/azure-developer-cli/install-azd), and run the following commands and sequence and follow the prompts:

```shell
# CD to your app's repo root
cd <repo-root>
# Initialize a new azd environment with this template
azd init --template dotnet-app-service-sqldb-infra
# Provision resources and deploy application code
azd up
```

When `azd` has finished deploying, you'll see some helpful output as provided by the template

- An endpoint URI for the web app.
- A link to the resource group in the Azure portal.
- A list of connection settings generated by the template, and links to the app settings page and the connection strings page in the Azure portal.
- A link to open an SSH session with the web app. This is useful to run database migrations manually.
- A link to the App Service logs.

When you've made any changes to your application code, you can just run:

```shell
azd deploy
```

## How does the AZD template configure passwords?

Two types of secrets are involved: the SQL Database administrator password and the access key for Cache for Redis, and they are both present in the respective connection strings. The [AZD template](infra/resources.bicep) in this repo manages both connection strings in a key vault that's secured behind a private endpoint.

To simplify the scenario, the AZD template generates a new database password each time you run `azd provision` or `azd up`, and the database connection string in the key vault is modified too. If you want to fully utilize `secretOrRandomPassword` in the [parameter file](infra/main.parameters.json) by committing the automatically generated password to the key vault the first time and reading it on subsequent `azd` commands, you must relax the networking restriction of the key vault to allow traffic from public networks. For more information, see [What is the behavior of the `secretOrRandomPassword` function?](https://learn.microsoft.com/azure/developer/azure-developer-cli/faq#what-is-the-behavior-of-the--secretorrandompassword--function).


## Getting help

If you're working with this project and running into issues, please post in [Issues](/issues).